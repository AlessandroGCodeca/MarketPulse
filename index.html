<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Pulse 5.0: Ultimate</title>
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="app_icon.png">
    <meta name="theme-color" content="#050511">

    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' https://s3.tradingview.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://api.coingecko.com https://api.rss2json.com https://api.exchangerate-api.com; img-src 'self' data:; frame-src https://s.tradingview.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta name="referrer" content="strict-origin-when-cross-origin">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,600;0,700;1,600&display=swap"
        rel="stylesheet">
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        :root {
            /* Dark Mode (Default) */
            --bg-dark: #050511;
            --card-glass: rgba(22, 27, 34, 0.6);
            --card-border: rgba(255, 255, 255, 0.08);
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --header-bg: rgba(5, 5, 17, 0.7);

            --bullish: #22c55e;
            --bearish: #ef4444;
            --neutral: #eab308;
            --font-serif: 'Playfair Display', serif;
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;

            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.5);
            --toast-bg: #1e293b;
            --sidebar-width: 300px;

            --bullish-glow: rgba(34, 197, 94, 0.4);
            --bearish-glow: rgba(239, 68, 68, 0.4);
        }

        [data-theme="light"] {
            --bg-dark: #f8f9fa;
            --card-glass: rgba(255, 255, 255, 0.9);
            --card-border: rgba(0, 0, 0, 0.12);
            --text-primary: #1a1a1a;
            --text-secondary: #5f6368;
            --accent-blue: #2563eb;
            --header-bg: rgba(255, 255, 255, 0.95);
            --toast-bg: #ffffff;
            --bullish: #16a34a;
            --bearish: #dc2626;
            --neutral: #ca8a04;
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.1);
            --bullish-glow: rgba(22, 163, 74, 0.25);
            --bearish-glow: rgba(220, 38, 38, 0.25);
        }

        /* Light mode ambient background */
        [data-theme="light"] .ambient-light {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 50%, #f5f0ff 100%);
        }

        [data-theme="light"] .aurora-blob {
            opacity: 0.15;
        }

        [data-theme="light"] .blob-1 {
            background: #93c5fd;
        }

        [data-theme="light"] .blob-2 {
            background: #c4b5fd;
        }

        [data-theme="light"] .blob-3 {
            background: #86efac;
        }

        /* Light mode article cards */
        [data-theme="light"] .article-card {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        [data-theme="light"] .article-card:hover {
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.12);
        }

        /* Light mode sentiment card */
        [data-theme="light"] .sentiment-card {
            background: rgba(0, 0, 0, 0.03);
        }

        /* Light mode sidebar */
        [data-theme="light"] .analyst-sidebar {
            background: #ffffff;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
        }

        /* Light mode heatmap cells */
        [data-theme="light"] .heatmap-cell {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* Light mode filter chips */
        [data-theme="light"] .filter-chip {
            background: rgba(0, 0, 0, 0.04);
        }

        /* Light mode ticker */
        [data-theme="light"] .ticker-wrap {
            background: rgba(0, 0, 0, 0.02);
        }

        /* Light mode skeleton loading */
        [data-theme="light"] .skeleton {
            background: linear-gradient(90deg,
                    rgba(37, 99, 235, 0.08) 0%,
                    rgba(124, 58, 237, 0.12) 25%,
                    rgba(236, 72, 153, 0.1) 50%,
                    rgba(124, 58, 237, 0.12) 75%,
                    rgba(37, 99, 235, 0.08) 100%);
        }

        /* Light mode search input */
        [data-theme="light"] #search-input {
            background: rgba(0, 0, 0, 0.04);
        }

        /* Light mode nav select */
        [data-theme="light"] select.nav-select {
            background: rgba(0, 0, 0, 0.04);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-family: var(--font-sans);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        /* Layout */
        .app-container {
            transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-open .app-container {
            margin-right: var(--sidebar-width);
        }

        /* Aura BG */
        /* Aurora BG */
        .ambient-light {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            pointer-events: none;
            overflow: hidden;
            background: #050511;
        }

        .aurora-blob {
            position: absolute;
            filter: blur(80px);
            opacity: var(--aurora-intensity, 0.4);
            animation: float var(--aurora-speed, 20s) infinite alternate;
            transition: opacity 2s ease, filter 2s ease;
        }

        /* Volatility states */
        .ambient-light.volatile .aurora-blob {
            filter: blur(60px);
            animation-duration: 8s;
        }

        .ambient-light.calm .aurora-blob {
            filter: blur(100px);
            animation-duration: 30s;
        }

        .blob-1 {
            top: -10%;
            left: -10%;
            width: 50vw;
            height: 50vh;
            background: #4f46e5;
            animation-delay: 0s;
        }

        .blob-2 {
            bottom: -10%;
            right: -10%;
            width: 60vw;
            height: 60vh;
            background: #7c3aed;
            animation-delay: -5s;
        }

        .blob-3 {
            top: 40%;
            left: 40%;
            width: 40vw;
            height: 40vh;
            background: #059669;
            animation-delay: -10s;
        }

        @keyframes float {
            0% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(30px, -50px) scale(1.1);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        /* Header */
        header {
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--card-border);
            background: var(--header-bg);
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-area h1 {
            font-family: var(--font-serif);
            font-size: 24px;
            font-weight: 700;
        }

        .logo-area span {
            font-size: 11px;
            opacity: 0.7;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 5px;
            position: relative;
            transition: color 0.2s;
        }

        .icon-btn:hover {
            color: var(--text-primary);
        }

        .icon-btn.active {
            color: var(--accent-blue);
        }



        select.nav-select {
            background: rgba(255, 255, 255, 0.05);
            color: inherit;
            border: 1px solid var(--card-border);
            padding: 5px 8px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            outline: none;
        }

        /* Ticker */
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--card-border);
            height: 40px;
            display: flex;
            align-items: center;
        }

        .ticker {
            display: flex;
            white-space: nowrap;
            animation: ticker 80s linear infinite;
        }

        .ticker:hover {
            animation-play-state: paused;
        }

        .ticker-item {
            margin-right: 30px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .ticker-item:hover {
            color: var(--text-primary);
        }

        @keyframes ticker {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        /* Main Content */
        main {
            padding: 30px 5%;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Sidebar (AI Analyst) */
        .analyst-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-dark);
            border-left: 1px solid var(--card-border);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 200;
            padding: 25px;
            overflow-y: auto;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
        }

        .sidebar-open .analyst-sidebar {
            transform: translateX(0);
        }

        .sidebar-header {
            font-family: var(--font-serif);
            font-size: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--card-border);
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sentiment-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .gauge-val {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }

        .analysis-point {
            margin-bottom: 15px;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            border-left: 2px solid var(--accent-blue);
            padding-left: 10px;
        }

        /* Chart Modal */
        .chart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .chart-content {
            width: 90%;
            height: 85%;
            background: var(--bg-dark);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .trade-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            color: white;
            transition: transform 0.1s;
        }

        .trade-btn:active {
            transform: scale(0.95);
        }

        .btn-buy {
            background: var(--bullish);
        }

        .btn-sell {
            background: var(--bearish);
        }

        /* Portfolio Modal */
        .portfolio-modal {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 300px;
            background: var(--bg-dark);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 500;
            display: none;
        }

        /* Word Cloud & Heatmap */
        .cloud-tag {
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
            display: inline-block;
            margin: 4px;
        }

        .cloud-tag:hover {
            color: var(--accent-blue);
            transform: scale(1.1);
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            height: 400px;
        }

        .heatmap-cell {
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            backdrop-filter: blur(8px);
            position: relative;
            overflow: hidden;
        }

        .heatmap-cell::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            padding: 2px;
            background: linear-gradient(135deg, transparent, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .heatmap-cell:hover::before {
            background: linear-gradient(135deg, var(--accent-blue), #7c3aed, #ec4899);
            opacity: 1;
            animation: gradient-rotate 3s linear infinite;
        }

        .heatmap-cell:hover {
            transform: scale(1.03);
            z-index: 2;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);
        }

        .view-hidden {
            display: none !important;
        }

        .masonry-grid {
            column-count: 3;
            column-gap: 20px;
        }

        @media (max-width: 1000px) {
            .masonry-grid {
                column-count: 2;
            }
        }

        @media (max-width: 600px) {
            .masonry-grid {
                column-count: 1;
            }
        }

        /* Adjust heatmap grid for more sectors */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            /* Responsive */
            gap: 10px;
            height: auto;
            /* Allow auto height */
            min-height: 400px;
        }

        .article-card {
            background: rgba(22, 27, 34, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            break-inside: avoid;
            transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
            position: relative;
            overflow: hidden;
        }

        .article-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            padding: 1px;
            background: linear-gradient(135deg, transparent, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .article-card:hover::before {
            background: linear-gradient(135deg, var(--accent-blue), #7c3aed, #ec4899);
            opacity: 1;
            animation: gradient-rotate 3s linear infinite;
        }

        .article-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.15);
        }

        @keyframes gradient-rotate {
            0% {
                filter: hue-rotate(0deg);
            }

            100% {
                filter: hue-rotate(360deg);
            }
        }

        .headline {
            font-family: var(--font-serif);
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: var(--toast-bg);
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-blue);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateX(100%);
            transition: transform 0.3s;
            max-width: 300px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid var(--card-border);
            pointer-events: auto;
        }

        /* =============================================
           MOBILE RESPONSIVE STYLES
           ============================================= */

        /* Tablet (768px and below) */
        @media (max-width: 768px) {

            /* Header adjustments */
            header {
                padding: 12px 4%;
                flex-wrap: wrap;
                gap: 10px;
            }

            .logo-area h1 {
                font-size: 20px;
            }

            .logo-area span {
                font-size: 10px;
            }

            #market-clocks {
                display: none !important;
            }

            .header-controls {
                gap: 6px;
            }

            .header-controls .icon-btn {
                padding: 8px;
                font-size: 16px;
            }

            .header-controls .nav-select {
                padding: 4px 6px;
                font-size: 11px;
            }

            /* Sidebar */
            .analyst-sidebar {
                width: 100%;
                padding: 20px 15px;
            }

            /* Main content */
            main {
                padding: 20px 4%;
            }

            /* Market status bar */
            #market-status-bar {
                gap: 10px !important;
                padding: 10px !important;
                font-size: 10px !important;
            }

            /* Word cloud */
            #word-cloud {
                padding-bottom: 15px;
                margin-bottom: 20px;
            }

            /* Screener controls - horizontal scroll */
            .screener-controls {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding-bottom: 5px;
            }

            .screener-controls::-webkit-scrollbar {
                display: none;
            }

            #search-input {
                width: 140px !important;
                font-size: 11px !important;
            }

            .filter-chip {
                padding: 6px 10px;
                font-size: 11px;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Article cards */
            .article-card {
                padding: 15px;
                margin-bottom: 15px;
            }

            .headline {
                font-size: 15px;
            }

            /* Heatmap cells */
            .heatmap-cell {
                padding: 15px 10px;
                font-size: 12px;
            }

            .heatmap-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            /* Toast notifications */
            .toast-container {
                bottom: 70px;
                right: 10px;
                left: 10px;
            }

            .toast {
                max-width: 100%;
                font-size: 12px;
                padding: 12px 15px;
            }

            /* Chart modal */
            .chart-content {
                width: 95%;
                height: 90%;
                padding: 15px;
                border-radius: 8px;
            }

            /* News modal */
            #news-modal .chart-content {
                padding: 25px 20px !important;
                max-width: 95% !important;
            }

            #news-headline {
                font-size: 18px !important;
            }

            #news-snippet {
                font-size: 14px !important;
            }

            /* Footer */
            footer {
                padding: 15px !important;
                font-size: 11px !important;
            }
        }

        /* Mobile phones (480px and below) */
        @media (max-width: 480px) {

            /* Header stacking */
            header {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px 4%;
            }

            .logo-area {
                width: 100%;
                margin-bottom: 5px;
            }

            .logo-area h1 {
                font-size: 18px;
            }

            .header-controls {
                width: 100%;
                justify-content: space-between;
            }

            /* Show only essential controls */
            .header-controls .nav-select {
                display: block;
                flex: 1;
                max-width: 80px;
            }

            .header-controls .icon-btn {
                display: flex;
                padding: 6px;
                font-size: 14px;
            }

            /* Ticker */
            .ticker-wrap {
                height: 35px;
            }

            .ticker-item {
                font-size: 11px;
                margin-right: 20px;
            }

            /* Main content */
            main {
                padding: 15px 3%;
            }

            /* Screener controls */
            .screener-controls>span:first-child {
                display: none;
            }

            #search-input {
                width: 120px !important;
                padding: 5px 10px !important;
            }

            .filter-chip {
                padding: 5px 8px;
                font-size: 10px;
                margin-right: 4px;
            }

            /* Word cloud reduced */
            .cloud-tag {
                font-size: 90% !important;
            }

            /* Article cards */
            .article-card {
                padding: 12px;
                border-radius: 10px;
            }

            .headline {
                font-size: 14px;
                line-height: 1.4;
            }

            /* Heatmap */
            .heatmap-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .heatmap-cell {
                padding: 12px 8px;
                border-radius: 8px;
            }

            .heatmap-cell div:first-child {
                font-size: 11px !important;
            }

            .heatmap-cell div:nth-child(2) {
                font-size: 12px !important;
            }

            /* Sidebar */
            .analyst-sidebar {
                padding: 15px 12px;
            }

            .sidebar-header {
                font-size: 16px;
            }

            .sentiment-card {
                padding: 15px;
            }

            .gauge-val {
                font-size: 26px;
            }

            .analysis-point {
                font-size: 12px;
            }

            /* Modals fullscreen */
            .chart-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }

            #news-modal .chart-content {
                border-radius: 12px !important;
            }

            /* Toast */
            .toast-container {
                bottom: 60px;
                left: 8px;
                right: 8px;
            }

            .toast {
                padding: 10px 12px;
                font-size: 11px;
            }
        }

        /* Very small phones (360px and below) */
        @media (max-width: 360px) {
            .logo-area h1 {
                font-size: 16px;
            }

            .header-controls .icon-btn {
                padding: 5px;
                font-size: 12px;
            }

            .filter-chip {
                padding: 4px 6px;
                font-size: 9px;
            }

            #search-input {
                width: 100px !important;
            }

            .headline {
                font-size: 13px;
            }

            .heatmap-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {

            /* Larger touch targets */
            .icon-btn {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .filter-chip {
                min-height: 36px;
                display: flex;
                align-items: center;
            }

            .ticker-item {
                padding: 8px 4px;
            }

            /* Disable hover effects on touch */
            .article-card:hover {
                transform: none;
            }

            .heatmap-cell:hover {
                transform: none;
            }

            /* Active states instead */
            .article-card:active {
                transform: scale(0.98);
            }

            .heatmap-cell:active {
                transform: scale(0.97);
            }

            .filter-chip:active {
                transform: scale(0.95);
            }
        }

        /* Safe area for notched phones */
        @supports (padding: max(0px)) {
            header {
                padding-left: max(4%, env(safe-area-inset-left));
                padding-right: max(4%, env(safe-area-inset-right));
            }

            main {
                padding-left: max(4%, env(safe-area-inset-left));
                padding-right: max(4%, env(safe-area-inset-right));
            }

            footer {
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }

            .toast-container {
                bottom: max(20px, calc(env(safe-area-inset-bottom) + 10px));
            }
        }

        /* Landscape mode adjustments */
        @media (max-height: 500px) and (orientation: landscape) {
            header {
                padding: 8px 4%;
            }

            .ticker-wrap {
                height: 30px;
            }

            main {
                padding: 10px 4%;
            }

            .chart-content {
                height: 95%;
            }
        }

        /* Reduced motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            .ticker {
                animation: none;
            }

            .aurora-blob {
                animation: none;
            }

            .article-card,
            .heatmap-cell,
            .filter-chip {
                transition: none;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --card-border: rgba(255, 255, 255, 0.3);
            }

            [data-theme="light"] {
                --card-border: rgba(0, 0, 0, 0.3);
            }
        }

        /* Neon & Ripple */
        .bullish-glow {
            box-shadow: 0 0 15px var(--bullish-glow);
            border-color: var(--bullish) !important;
        }

        .bearish-glow {
            box-shadow: 0 0 15px var(--bearish-glow);
            border-color: var(--bearish) !important;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            background-color: rgba(255, 255, 255, 0.3);
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Monospace Application */
        .ticker-item span:last-child,
        .heatmap-cell div:nth-child(2),
        .sector-list td,
        .gauge-val,
        #time-ny,
        #time-ldn,
        #time-tky {
            font-family: var(--font-mono);
            letter-spacing: -0.5px;
        }


        .skeleton {
            background: linear-gradient(90deg,
                    rgba(59, 130, 246, 0.1) 0%,
                    rgba(124, 58, 237, 0.2) 25%,
                    rgba(236, 72, 153, 0.15) 50%,
                    rgba(124, 58, 237, 0.2) 75%,
                    rgba(59, 130, 246, 0.1) 100%);
            background-size: 400% 100%;
            animation: aurora-shimmer 2s ease-in-out infinite;
            border-radius: 8px;
            color: transparent !important;
            user-select: none;
            position: relative;
            overflow: hidden;
        }

        .skeleton::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.1) 50%,
                    transparent 100%);
            animation: shimmer-sweep 1.5s ease-in-out infinite;
        }

        @keyframes aurora-shimmer {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes shimmer-sweep {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }
    </style>
</head>

<body>
    <div class="ambient-light">
        <div class="aurora-blob blob-1"></div>
        <div class="aurora-blob blob-2"></div>
        <div class="aurora-blob blob-3"></div>
    </div>

    <div class="analyst-sidebar" id="sidebar">
        <div class="sidebar-header">
            <span data-i18n="analyst">AI Market Analyst</span>
            <button onclick="toggleSidebar()"
                style="background:none;border:none;color:inherit;cursor:pointer">‚úï</button>
        </div>
        <div class="sentiment-card">
            <div style="font-size:12px;text-transform:uppercase;opacity:0.7" data-i18n="fearGreed">Fear & Greed Index
            </div>
            <div id="sentiment-val" class="gauge-val" style="color:var(--neutral)">50</div>
            <div id="sentiment-text" style="font-size:14px">Neutral</div>
        </div>
        <div style="margin-bottom:20px; font-weight:600; font-size:14px" data-i18n="insights">Market Insights</div>
        <div id="analyst-insights"></div>

        <!-- Economic Indicators -->
        <div style="margin-top:25px; border-top:1px solid var(--card-border); padding-top:15px;">
            <div style="font-weight:600; font-size:12px; margin-bottom:12px; text-transform:uppercase; opacity:0.7">üìä
                Economic Indicators</div>
            <div id="economic-indicators" style="font-size:12px;"></div>
        </div>

        <!-- Correlation Matrix -->
        <div style="margin-top:20px; border-top:1px solid var(--card-border); padding-top:15px;">
            <div style="font-weight:600; font-size:12px; margin-bottom:12px; text-transform:uppercase; opacity:0.7">üîó
                Asset Correlations</div>
            <div id="correlation-matrix"
                style="display:grid; grid-template-columns:repeat(4,1fr); gap:4px; font-size:9px;"></div>
        </div>
    </div>



    <div class="app-container">
        <div class="ticker-wrap">
            <div class="ticker" id="ticker"></div>
            <div class="ticker" id="ticker-2" aria-hidden="true"></div>
        </div>

        <header>
            <div class="logo-area">
                <h1 data-i18n="title">Market Pulse</h1>
                <span data-i18n="subtitle">Ultimate Logic</span>
                <div id="market-clocks"
                    style="display:flex; gap:15px; margin-top:5px; font-size:10px; opacity:0.8; font-family:var(--font-mono)">
                    <span>NY: <b id="time-ny">--:--</b></span>
                    <span>LDN: <b id="time-ldn">--:--</b></span>
                    <span>TKY: <b id="time-tky">--:--</b></span>
                </div>
            </div>
            <div class="header-controls">

                <select id="currency-select" class="nav-select">
                    <option value="USD">USD ($)</option>
                    <option value="EUR">EUR (‚Ç¨)</option>
                    <option value="GBP">GBP (¬£)</option>
                    <option value="JPY">JPY (¬•)</option>
                </select>


                <button class="icon-btn" onclick="toggleTheme()" title="Toggle Theme">üåó</button>
                <button class="icon-btn" onclick="toggleSidebar()" title="AI Analyst">ü§ñ</button>
                <button class="icon-btn" onclick="exportCSV()" title="Export CSV">üì•</button>
            </div>
        </header>

        <main>
            <!-- Market Status Bar -->
            <div id="market-status-bar"
                style="display:flex; gap:20px; justify-content:center; margin-bottom:20px; padding:12px; background:rgba(255,255,255,0.03); border-radius:8px; font-size:11px; flex-wrap:wrap;">
            </div>


            <div id="word-cloud"
                style="text-align:center; margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid var(--card-border)">
            </div>

            <!-- Stock Screener & View Controls -->
            <div
                style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center; flex-wrap:wrap; gap:10px">
                <div class="screener-controls" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                    <span style="font-size:12px; opacity:0.7; font-weight:600" data-i18n="screener">SCREENER:</span>
                    <input type="text" id="search-input" placeholder="Search stocks, crypto..." style="background: rgba(255,255,255,0.05); border: 1px solid var(--card-border); 
                        border-radius: 20px; padding: 6px 14px; font-size: 12px; color: var(--text-primary);
                        width: 180px; outline: none; transition: border-color 0.2s;" oninput="handleSearch(this.value)"
                        onfocus="this.style.borderColor='var(--accent-blue)'"
                        onblur="this.style.borderColor='var(--card-border)'">
                    <button class="filter-chip active" onclick="applyScreener('all')">All</button>
                    <button class="filter-chip" onclick="applyScreener('gainers')">Top Gainers</button>
                    <button class="filter-chip" onclick="applyScreener('crypto')">Crypto</button>
                    <button class="filter-chip" onclick="applyScreener('tech')">Tech Only</button>
                    <button class="filter-chip" onclick="applyScreener('saved')" id="saved-filter">üîñ Saved</button>
                </div>
                <div>
                    <button class="icon-btn" onclick="updateNews(true)" title="Refresh Feed">üîÑ</button>
                    <button class="icon-btn active" onclick="setView('grid')" data-i18n="grid">Grid</button>
                    <button class="icon-btn" onclick="setView('heatmap')" data-i18n="heatmap">Heatmap</button>
                </div>
            </div>

            <div id="grid-view" class="masonry-grid"></div>
            <div id="heatmap-view" class="heatmap-grid view-hidden"></div>

        </main>

        <footer
            style="text-align:center; padding: 20px; font-size: 12px; opacity: 0.5; border-top: 1px solid var(--card-border); margin-top: 20px;">
            &copy; 2026 Alessandro Giovanni Codec√†. All rights reserved.
        </footer>
    </div>

    <!-- Updated Styles -->
    <style>
        .filter-chip {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 5px;
        }

        .filter-chip:hover,
        .filter-chip.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .calendar-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .cal-date {
            opacity: 0.6;
            font-size: 11px;
        }

        .cal-impact {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        /* Ticker Flash & Tooltip */
        @keyframes flash-green {
            0% {
                background-color: rgba(34, 197, 94, 0.5);
            }

            100% {
                background-color: transparent;
            }
        }

        @keyframes flash-red {
            0% {
                background-color: rgba(239, 68, 68, 0.5);
            }

            100% {
                background-color: transparent;
            }
        }

        .flash-up {
            animation: flash-green 1s ease-out;
            border-radius: 4px;
        }

        .flash-down {
            animation: flash-red 1s ease-out;
            border-radius: 4px;
        }

        #ticker-tooltip {
            position: fixed;
            z-index: 10000;
            background: var(--toast-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            padding: 10px;
            border-radius: 8px;
            box-shadow: var(--shadow-soft);
            font-size: 12px;
            pointer-events: none;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            min-width: 150px;
        }

        /* Timeline */
        .timeline-container {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            mask-image: linear-gradient(to right, black 80%, transparent 100%);
        }

        .timeline-event {
            flex: 0 0 auto;
            min-width: 140px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 3px solid var(--text-secondary);
            font-size: 12px;
        }

        .timeline-event.active {
            border-left-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        /* Mobile Nav */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--header-bg);
            border-top: 1px solid var(--card-border);
            padding: 10px 0;
            justify-content: space-around;
            backdrop-filter: blur(20px);
            z-index: 900;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            color: var(--text-secondary);
            gap: 4px;
            text-decoration: none;
            background: none;
            border: none;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--accent-blue);
        }

        .nav-item span {
            font-size: 18px;
        }

        /* Mobile nav visibility - complements main responsive styles */
        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
            }

            /* Add padding for fixed mobile nav */
            body {
                padding-bottom: 70px;
            }
        }
    </style>

    <!-- Chart Modal -->
    <div class="chart-modal" id="chart-modal" onclick="if(event.target===this) closeChart()">
        <div class="chart-content">
            <div class="chart-header">
                <div>
                    <h2 id="chart-title" style="font-family:var(--font-serif)">Asset Chart</h2>
                </div>
                <button onclick="closeChart()"
                    style="background:none;border:none;color:inherit;font-size:20px;cursor:pointer">‚úï</button>
            </div>
            <div id="tv-chart" style="flex:1; width:100%; height:100%"></div>
        </div>
    </div>

    <!-- News Modal -->
    <div class="chart-modal" id="news-modal" onclick="if(event.target===this) closeNews()">
        <div class="chart-content"
            style="height:auto; max-width:600px; padding:40px; text-align:center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
            <div style="font-size:12px; opacity:0.6; text-transform:uppercase; margin-bottom:10px" id="news-source">
                Source
            </div>
            <h2 id="news-headline" style="font-family:var(--font-serif); font-size:24px; margin-bottom:20px">Headline
            </h2>
            <p id="news-snippet"
                style="font-size:16px; line-height:1.6; color:var(--text-secondary); margin-bottom:30px">
                Snippet</p>
            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-bottom:20px;">
                <button id="news-link-btn" class="trade-btn btn-buy" style="font-size:14px; padding:10px 24px;">Read
                    Full Article</button>
            </div>
            <!-- Social Sharing -->
            <div
                style="display:flex; gap:12px; justify-content:center; margin-top:15px; padding-top:15px; border-top:1px solid var(--card-border);">
                <button onclick="shareToTwitter()"
                    style="background:none; border:none; cursor:pointer; font-size:20px; opacity:0.7; transition:opacity 0.2s;"
                    onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7"
                    title="Share on X/Twitter">ùïè</button>
                <button onclick="shareToLinkedIn()"
                    style="background:none; border:none; cursor:pointer; font-size:20px; opacity:0.7; transition:opacity 0.2s;"
                    onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7"
                    title="Share on LinkedIn">üíº</button>
                <button onclick="copyNewsLink()"
                    style="background:none; border:none; cursor:pointer; font-size:20px; opacity:0.7; transition:opacity 0.2s;"
                    onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7" title="Copy Link">üîó</button>
            </div>
        </div>
    </div>

    <!-- Global Hover Tooltip -->
    <div id="ticker-tooltip"></div>

    <!-- Sector Modal (Drill Down) -->
    <div class="chart-modal" id="sector-modal" onclick="if(event.target===this) closeSector()">
        <div class="chart-content" style="max-width:800px; height:80%">
            <div class="chart-header">
                <div>
                    <h2 id="sector-title" style="font-family:var(--font-serif)">Sector Details</h2>
                    <div style="font-size:12px; opacity:0.6" id="sector-subtitle">Performance Overview</div>
                </div>
                <button onclick="closeSector()"
                    style="background:none;border:none;color:inherit;font-size:20px;cursor:pointer">‚úï</button>
            </div>
            <div style="overflow-y:auto; flex:1">
                <table style="width:100%; border-collapse:collapse; font-size:14px;">
                    <thead>
                        <tr style="text-align:left; border-bottom:1px solid var(--card-border); opacity:0.7">
                            <th style="padding:10px">Asset</th>
                            <th style="padding:10px">Price</th>
                            <th style="padding:10px">Trend</th>
                            <th style="padding:10px; text-align:right">Change</th>
                        </tr>
                    </thead>
                    <tbody id="sector-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <button class="nav-item active"
            onclick="setView('grid'); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); this.classList.add('active')">
            <span>üì∞</span> Home
        </button>
        <button class="nav-item"
            onclick="setView('heatmap'); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); this.classList.add('active')">
            <span>üìä</span> Market
        </button>
        <button class="nav-item" onclick="toggleSidebar()">
            <span>ü§ñ</span> Analyst
        </button>
    </nav>

    <!-- Toasts -->
    <div class="toast-container" id="toast-container"></div>

    <script src="data.js"></script>
    <script src="security.js"></script>
    <script>
        let currentLang = 'en';

        // --- State ---
        let currentCurrency = 'USD';
        let currentAssetId = null;
        let isLoading = true;
        let filteredArticles = []; // Global for interactions
        const rates = { 'USD': 1, 'EUR': 0.92, 'GBP': 0.79 };
        const syms = { 'USD': '$', 'EUR': '‚Ç¨', 'GBP': '¬£' };

        // --- Data Service ---
        const DataService = {
            coingeckoMap: {
                'BTC': 'bitcoin', 'ETH': 'ethereum', 'SOL': 'solana', 'BNB': 'binancecoin',
                'XRP': 'ripple', 'ADA': 'cardano', 'DOGE': 'dogecoin', 'DOT': 'polkadot',
                'LINK': 'chainlink', 'MATIC': 'matic-network', 'LTC': 'litecoin',
                'UNI': 'uniswap', 'AVAX': 'avalanche-2', 'SHIB': 'shiba-inu', 'TON': 'the-open-network'
            },

            async fetchCryptoPrices() {
                try {
                    const ids = Object.values(this.coingeckoMap).join(',');
                    // Use SecureFetch with rate limiting
                    const res = await SecureFetch.fetch(
                        `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd`,
                        'coingecko'
                    );
                    if (!res.ok) {
                        if (res.status === 429) console.warn('CoinGecko: Rate limited');
                        throw new Error('API Rate Limit');
                    }
                    const data = await res.json();
                    return data;
                } catch (e) {
                    console.warn('Crypto API Error (using sim):', e);
                    return null;
                }
            },

            async updateAssets() {
                const cryptoData = await this.fetchCryptoPrices();

                assets.forEach(a => {
                    let price = a.price;

                    if (a.type === 'crypto' && cryptoData && DataService.coingeckoMap[a.id]) {
                        const newPrice = cryptoData[DataService.coingeckoMap[a.id]]?.usd;
                        if (newPrice) price = newPrice;
                    } else {
                        // Simulation Fallback for Stocks/Others (or if API fails)
                        const change = (Math.random() - 0.5) * (a.price * 0.005);
                        price += change;
                    }

                    a.price = price;
                    a.history.push(price);
                    if (a.history.length > 100) a.history.shift();
                });

                renderTicker();
                renderHeatmap(); // Update heatmap values
                if (currentAssetId) openChart(currentAssetId); // Live chart update
            }
        };

        // --- Init Ticker (CRITICAL: Must run first to populate asset history) ---
        function initTicker() {
            assets.forEach(a => {
                if (!a.history || a.history.length === 0) {
                    a.history = Array(20).fill(a.price);
                }
            });
        }

        // --- Dynamic News Engine (Hybrid: RSS + Simulation) ---
        const RSSFetcher = {
            feeds: {
                "The Economist": "https://www.economist.com/finance-and-economics/rss.xml",
                "Bloomberg": "https://feeds.bloomberg.com/markets/news.rss",
                "Wall Street Journal": "https://feeds.a.dj.com/rss/RSSMarketsMain.xml",
                "Forbes": "https://www.forbes.com/investing/feed/",
                "Marketwatch": "http://feeds.marketwatch.com/marketwatch/topstories/",
                "Reuters": "https://www.reutersagency.com/feed/?best-topics=business-finance&post_type=best",
                "CNBC": "https://www.cnbc.com/id/10000664/device/rss/rss.html",
                "Barron's": "https://feeds.barrons.com/barrons/index.xml",
                "Business Insider": "https://feeds.businessinsider.com/custom/all",
                "Yahoo Finance": "https://finance.yahoo.com/news/rssindex",
                "Harvard Business Review": "http://feeds.hbr.org/harvardbusiness",
                "Financial Times": "https://www.ft.com/?format=rss"
            },

            async fetchNews(sourceName) {
                const url = this.feeds[sourceName];
                if (!url) return null;

                try {
                    // Use SecureFetch with rate limiting
                    const response = await SecureFetch.fetch(
                        `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`,
                        'rss2json'
                    );
                    if (!response.ok) {
                        if (response.status === 429) console.warn('RSS2JSON: Rate limited');
                        return null;
                    }
                    const data = await response.json();

                    if (data.status === 'ok' && data.items.length > 0) {
                        const item = data.items[0]; // Get latest
                        // Use XSS sanitizer for external content
                        return {
                            source: XSSSanitizer.escapeHtml(sourceName),
                            headline: XSSSanitizer.escapeHtml(item.title || ''),
                            snippet: XSSSanitizer.sanitizeExternalContent(item.description || '').substring(0, 100) + '...',
                            link: XSSSanitizer.sanitizeUrl(item.link || '#'),
                            timestamp: Date.now()
                        };
                    }
                } catch (e) {
                    console.warn(`RSS Fetch failed for ${sourceName}, falling back to simulation.`);
                }
                return null;
            }
        };

        const NewsGenerator = {
            sources: ["The Economist", "Financial Times", "Bloomberg", "Wall Street Journal", "Forbes", "Marketwatch", "Reuters", "Investopedia", "Harvard Business Review", "Morningstar", "Business Insider", "Yahoo Finance", "CNBC", "Barron's"],
            verbs: ["surges", "soars", "plummets", "drops", "rallies", "stabilizes", "rebounds", "crashes", "jumps", "slides"],
            adjectives: ["unprecedented", "massive", "unexpected", "sharp", "steady", "volatile", "record-breaking", "sudden"],
            reasons: ["after Fed comments", "following earnings beat", "amid regulatory fears", "on tech optimism", "despite inflation data", "after analyst upgrade", "on supply chain woes", "amid geopolitical tension"],
            templates: [
                "{Asset} {Verb} {Reason} in early trading.",
                "{Source} reports {Adjective} outlook for {Sector} stocks.",
                "Why {Asset} is seeing {Adjective} volatility today.",
                "{Sector} market {Verb} as investors digest new data.",
                "Analysts warn of {Adjective} risks for {Asset} following {Reason}."
            ],

            generate() {
                const source = this.sources[Math.floor(Math.random() * this.sources.length)];
                const asset = assets[Math.floor(Math.random() * assets.length)];
                const verb = this.verbs[Math.floor(Math.random() * this.verbs.length)];
                const adj = this.adjectives[Math.floor(Math.random() * this.adjectives.length)];
                const reason = this.reasons[Math.floor(Math.random() * this.reasons.length)];
                const template = this.templates[Math.floor(Math.random() * this.templates.length)];

                const headline = template
                    .replace("{Asset}", asset.name)
                    .replace("{Verb}", verb)
                    .replace("{Reason}", reason)
                    .replace("{Source}", source)
                    .replace("{Adjective}", adj)
                    .replace("{Sector}", asset.sector);

                return {
                    source: source,
                    headline: headline,
                    snippet: `Latest updates from ${source} on the developing situation regarding ${asset.name}.`,
                    link: "#",
                    timestamp: Date.now()
                };
            }
        };

        async function updateNews(manual = false) {
            const btn = document.querySelector('button[title="Refresh Feed"]');
            if (manual && btn) {
                btn.style.transform = 'rotate(360deg)';
                btn.style.transition = 'transform 1s';
            }

            // Pick 1-2 sources to update
            const targets = manual ? 3 : 1;

            for (let i = 0; i < targets; i++) {
                // Try 50/50 Real vs Sim if manual, or just random source
                const sourceList = NewsGenerator.sources;
                const targetSource = sourceList[Math.floor(Math.random() * sourceList.length)];

                let article = await RSSFetcher.fetchNews(targetSource);

                // Fallback if RSS failed or no feed for this source
                if (!article) {
                    article = NewsGenerator.generate();
                }

                if (typeof marketData !== 'undefined' && marketData.length > 0) {
                    // Ensure uniqueness to avoid duplicate RSS items
                    const exists = marketData[0].articles.find(a => a.headline === article.headline);
                    if (!exists) {
                        marketData[0].articles.unshift(article);
                        if (marketData[0].articles.length > 50) marketData[0].articles.pop();
                    }
                }
            }

            renderGrid();

            if (manual && btn) {
                setTimeout(() => { btn.style.transform = 'none'; btn.style.transition = ''; }, 1000);
            }
        }

        // Micro-Interactions: Ripple Effect
        document.body.addEventListener('click', function (e) {
            const target = e.target.closest('button, .filter-chip, .ticker-item, .article-card');
            if (target) {
                const rect = target.getBoundingClientRect();
                const circle = document.createElement('span');
                const diameter = Math.max(rect.width, rect.height);
                const radius = diameter / 2;

                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${e.clientX - rect.left - radius}px`;
                circle.style.top = `${e.clientY - rect.top - radius}px`;
                circle.classList.add('ripple');

                const oldRipple = target.getElementsByClassName('ripple')[0];
                if (oldRipple) oldRipple.remove(); // Clean up

                if (window.getComputedStyle(target).position === 'static') {
                    target.style.position = 'relative';
                }
                if (window.getComputedStyle(target).overflow !== 'hidden') {
                    target.style.overflow = 'hidden';
                }

                target.appendChild(circle);
                setTimeout(() => circle.remove(), 600);
            }
        });

        // News Auto-Update (1 Hour)
        setInterval(() => updateNews(false), 3600000);

        const assets = [
            // Crypto (15)
            { id: 'BTC', name: 'Bitcoin', price: 92340, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'ETH', name: 'Ethereum', price: 3450, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'SOL', name: 'Solana', price: 145, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'BNB', name: 'Binance Coin', price: 605, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'XRP', name: 'XRP', price: 0.62, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'ADA', name: 'Cardano', price: 0.45, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'DOGE', name: 'Dogecoin', price: 0.16, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'DOT', name: 'Polkadot', price: 7.20, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'LINK', name: 'Chainlink', price: 18.50, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'MATIC', name: 'Polygon', price: 0.75, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'LTC', name: 'Litecoin', price: 85.30, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'UNI', name: 'Uniswap', price: 10.40, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'AVAX', name: 'Avalanche', price: 35.60, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'SHIB', name: 'Shiba Inu', price: 0.000025, type: 'crypto', sector: 'Crypto', history: [] },
            { id: 'TON', name: 'Toncoin', price: 6.80, type: 'crypto', sector: 'Crypto', history: [] },

            // Tech (20)
            { id: 'NVDA', name: 'Nvidia', price: 179.90, type: 'stock', sector: 'Tech', history: [] },
            { id: 'AAPL', name: 'Apple', price: 269.50, type: 'stock', sector: 'Tech', history: [] },
            { id: 'MSFT', name: 'Microsoft', price: 410.20, type: 'stock', sector: 'Tech', history: [] },
            { id: 'GOOGL', name: 'Alphabet', price: 175.60, type: 'stock', sector: 'Tech', history: [] },
            { id: 'AMZN', name: 'Amazon', price: 185.30, type: 'stock', sector: 'Tech', history: [] },
            { id: 'META', name: 'Meta', price: 490.50, type: 'stock', sector: 'Tech', history: [] },
            { id: 'NFLX', name: 'Netflix', price: 620.10, type: 'stock', sector: 'Tech', history: [] },
            { id: 'ADBE', name: 'Adobe', price: 540.25, type: 'stock', sector: 'Tech', history: [] },
            { id: 'ORCL', name: 'Oracle', price: 125.40, type: 'stock', sector: 'Tech', history: [] },
            { id: 'QCOM', name: 'Qualcomm', price: 165.80, type: 'stock', sector: 'Tech', history: [] },
            { id: 'INTC', name: 'Intel', price: 30.50, type: 'stock', sector: 'Tech', history: [] },
            { id: 'CSCO', name: 'Cisco', price: 48.20, type: 'stock', sector: 'Tech', history: [] },
            { id: 'IBM', name: 'IBM', price: 170.30, type: 'stock', sector: 'Tech', history: [] },
            { id: 'TXN', name: 'Texas Inst', price: 195.40, type: 'stock', sector: 'Tech', history: [] },
            { id: 'CRM', name: 'Salesforce', price: 280.50, type: 'stock', sector: 'Tech', history: [] },
            { id: 'PLTR', name: 'Palantir', price: 25.40, type: 'stock', sector: 'Tech', history: [] },
            { id: 'SHOP', name: 'Shopify', price: 75.20, type: 'stock', sector: 'Tech', history: [] },
            { id: 'UBER', name: 'Uber', price: 72.30, type: 'stock', sector: 'Tech', history: [] },
            { id: 'ABNB', name: 'Airbnb', price: 145.60, type: 'stock', sector: 'Tech', history: [] },
            { id: 'SQ', name: 'Block', price: 78.40, type: 'stock', sector: 'Tech', history: [] },

            // Auto & Transport (7)
            { id: 'TSLA', name: 'Tesla', price: 240.10, type: 'stock', sector: 'Auto', history: [] },
            { id: 'TM', name: 'Toyota', price: 195.30, type: 'stock', sector: 'Auto', history: [] },
            { id: 'F', name: 'Ford', price: 12.50, type: 'stock', sector: 'Auto', history: [] },
            { id: 'GM', name: 'General Motors', price: 45.20, type: 'stock', sector: 'Auto', history: [] },
            { id: 'HMC', name: 'Honda', price: 32.40, type: 'stock', sector: 'Auto', history: [] },
            { id: 'RACE', name: 'Ferrari', price: 410.50, type: 'stock', sector: 'Auto', history: [] },
            { id: 'UPS', name: 'UPS', price: 142.30, type: 'stock', sector: 'Auto', history: [] },

            // Finance (12)
            { id: 'JPM', name: 'JPMorgan', price: 205.40, type: 'stock', sector: 'Finance', history: [] },
            { id: 'V', name: 'Visa', price: 280.10, type: 'stock', sector: 'Finance', history: [] },
            { id: 'MA', name: 'Mastercard', price: 450.60, type: 'stock', sector: 'Finance', history: [] },
            { id: 'BAC', name: 'Bank of America', price: 38.90, type: 'stock', sector: 'Finance', history: [] },
            { id: 'GS', name: 'Goldman Sachs', price: 460.20, type: 'stock', sector: 'Finance', history: [] },
            { id: 'MS', name: 'Morgan Stanley', price: 98.40, type: 'stock', sector: 'Finance', history: [] },
            { id: 'C', name: 'Citigroup', price: 62.50, type: 'stock', sector: 'Finance', history: [] },
            { id: 'WFC', name: 'Wells Fargo', price: 58.20, type: 'stock', sector: 'Finance', history: [] },
            { id: 'AXP', name: 'Amex', price: 230.10, type: 'stock', sector: 'Finance', history: [] },
            { id: 'PYPL', name: 'PayPal', price: 65.30, type: 'stock', sector: 'Finance', history: [] },
            { id: 'BLK', name: 'BlackRock', price: 780.40, type: 'stock', sector: 'Finance', history: [] },
            { id: 'COIN', name: 'Coinbase', price: 220.50, type: 'stock', sector: 'Finance', history: [] },

            // Consumer (12)
            { id: 'WMT', name: 'Walmart', price: 68.50, type: 'stock', sector: 'Consumer', history: [] },
            { id: 'COST', name: 'Costco', price: 850.30, type: 'stock', sector: 'Consumer', history: [] },
            { id: 'KO', name: 'Coca-Cola', price: 62.40, type: 'stock', sector: 'Consumer', history: [] },
            { id: 'MCD', name: 'McDonald\'s', price: 270.80, type: 'stock', sector: 'Consumer', history: [] },
            { id: 'NKE', name: 'Nike', price: 92.60, type: 'stock', sector: 'Consumer', history: [] },
            { id: 'HD', name: 'Home Depot', price: 345.20, type: 'stock', sector: 'Consumer', history: [] },
            { id: 'LOW', name: 'Lowe\'s', price: 225.40, type: 'stock', sector: 'Consumer', history: [] },
            { id: 'SBUX', name: 'Starbucks', price: 85.30, type: 'stock', sector: 'Consumer', history: [] },
            { id: 'TGT', name: 'Target', price: 145.20, type: 'stock', sector: 'Consumer', history: [] },
            { id: 'PEP', name: 'PepsiCo', price: 168.40, type: 'stock', sector: 'Consumer', history: [] },
            { id: 'PG', name: 'P&G', price: 166.50, type: 'stock', sector: 'Consumer', history: [] },
            { id: 'DIS', name: 'Disney', price: 95.40, type: 'stock', sector: 'Consumer', history: [] },

            // Healthcare (10)
            { id: 'JNJ', name: 'J&J', price: 155.20, type: 'stock', sector: 'Healthcare', history: [] },
            { id: 'LLY', name: 'Eli Lilly', price: 890.10, type: 'stock', sector: 'Healthcare', history: [] },
            { id: 'PFE', name: 'Pfizer', price: 28.40, type: 'stock', sector: 'Healthcare', history: [] },
            { id: 'UNH', name: 'UnitedHealth', price: 510.20, type: 'stock', sector: 'Healthcare', history: [] },
            { id: 'MRK', name: 'Merck', price: 128.50, type: 'stock', sector: 'Healthcare', history: [] },
            { id: 'ABBV', name: 'AbbVie', price: 175.40, type: 'stock', sector: 'Healthcare', history: [] },
            { id: 'AMGN', name: 'Amgen', price: 315.60, type: 'stock', sector: 'Healthcare', history: [] },
            { id: 'ISRG', name: 'Intuitive Surg', price: 430.20, type: 'stock', sector: 'Healthcare', history: [] },
            { id: 'TMO', name: 'Thermo Fisher', price: 580.40, type: 'stock', sector: 'Healthcare', history: [] },
            { id: 'BMY', name: 'Bristol-Myers', price: 42.50, type: 'stock', sector: 'Healthcare', history: [] },

            // Industrial & Energy (12)
            { id: 'XOM', name: 'ExxonMobil', price: 115.60, type: 'stock', sector: 'Energy', history: [] },
            { id: 'CVX', name: 'Chevron', price: 158.30, type: 'stock', sector: 'Energy', history: [] },
            { id: 'BP', name: 'BP', price: 35.40, type: 'stock', sector: 'Energy', history: [] },
            { id: 'SHEL', name: 'Shell', price: 70.20, type: 'stock', sector: 'Energy', history: [] },
            { id: 'BA', name: 'Boeing', price: 175.40, type: 'stock', sector: 'Industrial', history: [] },
            { id: 'GE', name: 'GE Aerospace', price: 165.20, type: 'stock', sector: 'Industrial', history: [] },
            { id: 'CAT', name: 'Caterpillar', price: 340.50, type: 'stock', sector: 'Industrial', history: [] },
            { id: 'LMT', name: 'Lockheed', price: 465.30, type: 'stock', sector: 'Industrial', history: [] },
            { id: 'RTX', name: 'RTX Corp', price: 105.20, type: 'stock', sector: 'Industrial', history: [] },
            { id: 'HON', name: 'Honeywell', price: 205.40, type: 'stock', sector: 'Industrial', history: [] },
            { id: 'DE', name: 'Deere', price: 380.20, type: 'stock', sector: 'Industrial', history: [] },
            { id: 'NEE', name: 'NextEra', price: 78.40, type: 'stock', sector: 'Utilities', history: [] },

            // Commodities & Forex (12)
            { id: 'GOLD', name: 'Gold', price: 2450, type: 'commodity', sector: 'Commodities', history: [] },
            { id: 'SILVER', name: 'Silver', price: 29.50, type: 'commodity', sector: 'Commodities', history: [] },
            { id: 'OIL', name: 'Crude Oil', price: 75.20, type: 'commodity', sector: 'Commodities', history: [] },
            { id: 'NG', name: 'Natural Gas', price: 2.80, type: 'commodity', sector: 'Commodities', history: [] },
            { id: 'COPPER', name: 'Copper', price: 4.50, type: 'commodity', sector: 'Commodities', history: [] },
            { id: 'PLAT', name: 'Platinum', price: 980.50, type: 'commodity', sector: 'Commodities', history: [] },
            { id: 'WHEAT', name: 'Wheat', price: 580.00, type: 'commodity', sector: 'Commodities', history: [] },
            { id: 'EURUSD', name: 'EUR/USD', price: 1.08, type: 'forex', sector: 'Forex', history: [] },
            { id: 'GBPUSD', name: 'GBP/USD', price: 1.27, type: 'forex', sector: 'Forex', history: [] },
            { id: 'USDJPY', name: 'USD/JPY', price: 155.40, type: 'forex', sector: 'Forex', history: [] },
            { id: 'USDCAD', name: 'USD/CAD', price: 1.36, type: 'forex', sector: 'Forex', history: [] },
            { id: 'AUDUSD', name: 'AUD/USD', price: 0.66, type: 'forex', sector: 'Forex', history: [] }
        ];

        // Fill Data History
        assets.forEach(a => {
            let p = a.price;
            for (let i = 0; i < 100; i++) {
                p = p * (1 + (Math.random() - 0.5) * 0.02);
                a.history.push(p);
            }
        });

        // --- Init ---
        function init() {
            initTicker(); // Initialize asset data FIRST
            renderTicker();
            renderGrid();
            renderHeatmap();
            renderCloud();
            initPWA();
            analyzeSentiment();
            updateCalendar(); // New Calendar Widget
            updateMarketStatus(); // Market Status Indicator
            updateFearGreed(); // Enhanced Fear & Greed
            updateAuroraIntensity(); // Dynamic aurora
            initMobileGestures(); // Swipe & pinch
            initInfiniteScroll(); // Load more on scroll
            updateCorrelationMatrix(); // Asset correlations
            updateEconomicIndicators(); // Macro data
            setInterval(simulateMarket, 1000);
            setInterval(updateClocks, 1000);
            setInterval(updateMarketStatus, 60000); // Update market status every minute
            setInterval(checkMarketBell, 60000); // Check for market open/close
            setInterval(cycleTitle, 3000); // New Dynamic Title
            updateClocks();
            checkMarketBell(); // Initialize market state
            isLoading = false; // CRITICAL: Reveal the content after init
        }

        // --- Immersion Features ---
        let titleIdx = 0;
        function cycleTitle() {
            const keyAssets = ['BTC', 'NVDA', 'ETH', 'TSLA'];
            const a = assets.find(x => x.id === keyAssets[titleIdx % keyAssets.length]);
            titleIdx++;
            if (a) {
                const price = formatPrice(a.price).split('.')[0];
                document.title = `${a.id} ${price} | Market Pulse`
            }
        }

        // --- Clocks ---
        function updateClocks() {
            const now = new Date();
            const fmt = (tz) => now.toLocaleTimeString('en-US', { timeZone: tz, hour: '2-digit', minute: '2-digit', hour12: false });
            document.getElementById('time-ny').innerText = fmt('America/New_York');
            document.getElementById('time-ldn').innerText = fmt('Europe/London');
            document.getElementById('time-tky').innerText = fmt('Asia/Tokyo');
        }

        // --- Market Status Indicator ---
        function updateMarketStatus() {
            const now = new Date();
            const markets = [
                { name: 'NYSE', tz: 'America/New_York', open: 9.5, close: 16, flag: 'üá∫üá∏' },
                { name: 'LSE', tz: 'Europe/London', open: 8, close: 16.5, flag: 'üá¨üáß' },
                { name: 'TSE', tz: 'Asia/Tokyo', open: 9, close: 15, flag: 'üáØüáµ' }
            ];
            const statusBar = document.getElementById('market-status-bar');
            if (!statusBar) return;
            statusBar.innerHTML = markets.map(m => {
                const localTime = new Date(now.toLocaleString('en-US', { timeZone: m.tz }));
                const hours = localTime.getHours() + localTime.getMinutes() / 60;
                const isOpen = hours >= m.open && hours < m.close;
                const isWeekend = localTime.getDay() === 0 || localTime.getDay() === 6;
                let status, color, countdown;
                if (isWeekend) { status = 'CLOSED'; color = 'var(--text-secondary)'; countdown = 'Weekend'; }
                else if (isOpen) { status = 'OPEN'; color = 'var(--bullish)'; const minsLeft = Math.floor((m.close - hours) * 60); countdown = `Closes in ${Math.floor(minsLeft / 60)}h ${minsLeft % 60}m`; }
                else { status = 'CLOSED'; color = 'var(--bearish)'; const minsToOpen = hours < m.open ? Math.floor((m.open - hours) * 60) : Math.floor((24 - hours + m.open) * 60); countdown = `Opens in ${Math.floor(minsToOpen / 60)}h ${minsToOpen % 60}m`; }
                return `<div style="display:flex;align-items:center;gap:6px"><span>${m.flag}</span><span style="font-weight:600">${m.name}</span><span style="padding:2px 6px;border-radius:4px;background:${color}20;color:${color};font-weight:600">${status}</span><span style="opacity:0.6">${countdown}</span></div>`;
            }).join('');
        }

        // --- Top Movers ---
        function updateTopMovers() {
            const sorted = [...assets].map(a => ({ ...a, change: ((a.price - a.history[0]) / a.history[0]) * 100 })).sort((a, b) => b.change - a.change);
            const gainers = sorted.slice(0, 3);
            const losers = sorted.slice(-3).reverse();
            document.getElementById('top-gainers').innerHTML = gainers.map(a => `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer" onclick="openChart('${a.id}')"><span style="font-weight:500">${a.id}</span><span style="color:var(--bullish);font-family:var(--font-mono)">+${a.change.toFixed(2)}%</span></div>`).join('');
            document.getElementById('top-losers').innerHTML = losers.map(a => `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer" onclick="openChart('${a.id}')"><span style="font-weight:500">${a.id}</span><span style="color:var(--bearish);font-family:var(--font-mono)">${a.change.toFixed(2)}%</span></div>`).join('');
        }

        // --- Enhanced Fear & Greed ---
        function updateFearGreed() {
            let upCount = 0, totalChange = 0;
            assets.forEach(a => { const change = (a.price - a.history[0]) / a.history[0]; totalChange += change; if (change > 0) upCount++; });
            const upRatio = upCount / assets.length;
            const avgChange = totalChange / assets.length;
            let score = Math.round((upRatio * 50) + (Math.min(avgChange * 500, 50) + 50) / 2);
            score = Math.max(0, Math.min(100, score));
            let label, color;
            if (score < 25) { label = 'Extreme Fear'; color = 'var(--bearish)'; }
            else if (score < 40) { label = 'Fear'; color = '#f97316'; }
            else if (score < 60) { label = 'Neutral'; color = 'var(--neutral)'; }
            else if (score < 75) { label = 'Greed'; color = '#84cc16'; }
            else { label = 'Extreme Greed'; color = 'var(--bullish)'; }
            document.getElementById('sentiment-val').innerText = score;
            document.getElementById('sentiment-val').style.color = color;
            document.getElementById('sentiment-text').innerText = label;
        }

        // --- Dynamic Aurora Intensity ---
        function updateAuroraIntensity() {
            // Calculate market volatility from price changes
            let totalVolatility = 0;
            assets.forEach(a => {
                const change = Math.abs((a.price - a.history[0]) / a.history[0]);
                totalVolatility += change;
            });
            const avgVolatility = totalVolatility / assets.length;

            const ambient = document.querySelector('.ambient-light');
            if (!ambient) return;

            // Update intensity based on volatility
            const intensity = Math.min(0.3 + avgVolatility * 5, 0.7);
            document.documentElement.style.setProperty('--aurora-intensity', intensity);

            // Apply volatility class
            ambient.classList.remove('volatile', 'calm');
            if (avgVolatility > 0.02) {
                ambient.classList.add('volatile');
            } else if (avgVolatility < 0.005) {
                ambient.classList.add('calm');
            }
        }

        // --- Market Bell ---
        let bellMuted = false;
        let lastMarketState = {};

        // Base64 encoded soft bell sound
        const bellSound = new Audio('data:audio/wav;base64,UklGRl4EAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YToEAACAgICAgICAgICAgICAgICA/3+Ab319f4qMkpWTkY2IgoF+fHl3dnV1dnl8gIWKj5OWmZqYlI+JgntyamNfX2JocHmDjpefo6WloJmPg3ZqYFpYW2FrcnmAhoyRlZeXlZGMhoB5c25qZ2dpbHJ4fYOIjJCSlJSTkY2IgoB9e3p5eXl6fH+ChYiLjZCRkZCOjIqHhIKAgH9/f4CAgYOEhYaGh4eGhoWEg4KBgIB/f39/f4CAgYKDg4SFhYWFhIOCgYB/fn5+fn5/f4CAgYKCg4OEhISEg4OCgYB/fn5+fn5+f3+AgIGBgoKDg4ODg4KCgYCAf39+fn5+fn9/gICBgYKCgoKDg4OCgoGAgH9/f35+fn5/f4CAgIGBgoKCgoKCgoGBgIB/f35+fn5+fn9/gICAgYGCgoKCgoKBgYCAf39/fn5+fn5/f4CAgICBgYKCgoKCgYGAgIB/f35+fn5+fn9/gICAgYGBgoKCgoGBgICAgH9/fn5+fn5+f3+AgICAgYGBgoKCgYGAgIB/f39+fn5+fn5/f4CAgICBgYGCgoGBgYCAgH9/f35+fn5+fn9/gICAgIGBgYKCgYGBgICAf39/fn5+fn5+f3+AgICAgYGBgYGBgYGAgIB/f39+fn5+fn5/f4CAgICBgYGBgYGBgICAf39/fn5+fn5+f3+AgICAgIGBgYGBgYCAgIB/f39+fn5+fn5/f4CAgICBgYGBgYGAgICAf39/f35+fn5+f3+AgICAgIGBgYGBgYCAgIB/f39+fn5+fn5/f4CAgICAgYGBgYGAgICAf39/f35+fn5+f3+AgICAgIGBgYGBgYCAgIB/f39+fn5+fn5/f4CAgICAgYGBgYGAgICAf39/f35+fn5+f3+AgICAgICBgYGBgYCAgIB/f39+fn5+fn5/f4CAgICAgYGBgYCAgICAf39/f35+fn5+f3+AgICAgICBgYGBgICAf39/f39+fn5+fn5/f4CAgICAgYGBgYCAgIB/f39/fn5+fn5+f3+AgICAgICBgYGAgICAf39/f35+fn5+fn5/f4CAgICAgYGBgICAf39/f39+fn5+fn5/f4CAgICAgIGBgYCAgH9/f39/fn5+fn5+f3+AgICAgICBgYGAgIB/f39/f35+fn5+fn9/gICAgICAgYGAgICAf39/f39+fn5+fn5/f4CAgICAgICBgICAf39/f39/fn5+fn5+f3+AgICAgICAgYCAgH9/f39/f35+fn5+fn9/gICAgICAgICAgIB/f39/f39+fn5+fn5/f4CAgICAgICAgIB/f39/f39+fn5+fn5/f4CAgICAgICAgIB/f39/f35+fn5+fn5/gICAgICAgA==');
        bellSound.volume = 0.3;

        function checkMarketBell() {
            if (bellMuted) return;

            const now = new Date();
            const markets = [
                { name: 'NYSE', tz: 'America/New_York', open: 9.5, close: 16 },
                { name: 'LSE', tz: 'Europe/London', open: 8, close: 16.5 }
            ];

            markets.forEach(m => {
                const localTime = new Date(now.toLocaleString('en-US', { timeZone: m.tz }));
                const hours = localTime.getHours() + localTime.getMinutes() / 60;
                const isWeekend = localTime.getDay() === 0 || localTime.getDay() === 6;
                const isOpen = !isWeekend && hours >= m.open && hours < m.close;

                // Check for state change
                if (lastMarketState[m.name] !== undefined && lastMarketState[m.name] !== isOpen) {
                    bellSound.currentTime = 0;
                    bellSound.play().catch(() => { }); // Ignore autoplay restrictions
                    showToast(`üîî ${m.name} Market ${isOpen ? 'Open' : 'Closed'}`, isOpen ? 'up' : 'down');
                }
                lastMarketState[m.name] = isOpen;
            });
        }

        function toggleBellMute() {
            bellMuted = !bellMuted;
            const btn = document.getElementById('bell-mute-btn');
            if (btn) btn.innerText = bellMuted ? 'üîï' : 'üîî';
            showToast(bellMuted ? 'Market bell muted' : 'Market bell enabled', 'info');
        }

        // --- Infinite Scroll ---
        let newsPage = 0;
        const articlesPerPage = 6;
        let allNewsArticles = [];

        function initInfiniteScroll() {
            const grid = document.getElementById('grid-view');
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !isLoading) {
                    loadMoreNews();
                }
            }, { threshold: 0.1 });

            // Create sentinel element
            const sentinel = document.createElement('div');
            sentinel.id = 'scroll-sentinel';
            sentinel.style.height = '20px';
            grid.parentNode.insertBefore(sentinel, grid.nextSibling);
            observer.observe(sentinel);
        }

        function loadMoreNews() {
            const grid = document.getElementById('grid-view');
            const start = newsPage * articlesPerPage;
            const end = start + articlesPerPage;
            const moreArticles = filteredArticles.slice(start, end);

            if (moreArticles.length === 0) return;

            newsPage++;
            moreArticles.forEach((a, i) => {
                const idx = start + i;
                const sent = getSentiment(a.headline);
                const bookmarked = isBookmarked(a.id);
                const card = document.createElement('div');
                card.className = 'article-card';
                card.style.cursor = 'pointer';
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                         <div style="font-size:10px;opacity:0.6;text-transform:uppercase">${a.source || 'News'}</div>
                         <div style="display:flex;gap:8px;align-items:center">
                             <button onclick="event.stopPropagation();toggleBookmark('${a.id}')" style="background:none;border:none;cursor:pointer;font-size:14px;opacity:${bookmarked ? 1 : 0.4};transition:opacity 0.2s" title="${bookmarked ? 'Remove bookmark' : 'Save article'}">${bookmarked ? 'üîñ' : 'üìë'}</button>
                             <div style="font-size:9px;padding:2px 6px;border-radius:4px;background:${sent.color}20;color:${sent.color}">${sent.label}</div>
                         </div>
                    </div>
                    <div class="headline" onclick="openNews(${idx})">${a.headline}</div>
                    <div style="font-size:13px;opacity:0.8" onclick="openNews(${idx})">${a.snippet}</div>
                `;
                grid.appendChild(card);
            });
        }

        // --- Mobile Gestures ---
        let touchStartX = 0;
        let touchStartY = 0;
        let heatmapScale = 1;
        let initialPinchDistance = 0;

        function initMobileGestures() {
            const main = document.querySelector('main');
            if (!main) return;

            // Swipe left/right to switch views
            main.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                }
            }, { passive: true });

            main.addEventListener('touchend', (e) => {
                if (e.changedTouches.length === 1) {
                    const dx = e.changedTouches[0].clientX - touchStartX;
                    const dy = e.changedTouches[0].clientY - touchStartY;

                    // Only if horizontal swipe > 50px and more horizontal than vertical
                    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) * 1.5) {
                        const gridHidden = document.getElementById('grid-view').classList.contains('view-hidden');
                        if (dx > 0 && gridHidden) {
                            setView('grid');
                            showToast('üì∞ Grid View', 'info');
                        } else if (dx < 0 && !gridHidden) {
                            setView('heatmap');
                            showToast('üî• Heatmap View', 'info');
                        }
                    }
                }
            }, { passive: true });

            // Pinch-to-zoom on heatmap
            const heatmap = document.getElementById('heatmap-view');
            if (heatmap) {
                heatmap.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 2) {
                        initialPinchDistance = Math.hypot(
                            e.touches[1].clientX - e.touches[0].clientX,
                            e.touches[1].clientY - e.touches[0].clientY
                        );
                    }
                }, { passive: true });

                heatmap.addEventListener('touchmove', (e) => {
                    if (e.touches.length === 2) {
                        const currentDistance = Math.hypot(
                            e.touches[1].clientX - e.touches[0].clientX,
                            e.touches[1].clientY - e.touches[0].clientY
                        );
                        const scaleDelta = currentDistance / initialPinchDistance;
                        heatmapScale = Math.min(Math.max(heatmapScale * scaleDelta, 0.5), 3);
                        heatmap.style.transform = `scale(${heatmapScale})`;
                        heatmap.style.transformOrigin = 'center center';
                        initialPinchDistance = currentDistance;
                    }
                }, { passive: true });

                // Double-tap to reset zoom
                let lastTap = 0;
                heatmap.addEventListener('touchend', (e) => {
                    const now = Date.now();
                    if (now - lastTap < 300) {
                        heatmapScale = 1;
                        heatmap.style.transform = 'scale(1)';
                        showToast('üîÑ Zoom reset', 'info');
                    }
                    lastTap = now;
                });
            }
        }

        // --- Correlation Matrix ---
        function calculateCorrelation(arr1, arr2) {
            const n = Math.min(arr1.length, arr2.length, 20);
            if (n < 2) return 0;
            const s1 = arr1.slice(-n), s2 = arr2.slice(-n);
            const mean1 = s1.reduce((a, b) => a + b, 0) / n;
            const mean2 = s2.reduce((a, b) => a + b, 0) / n;
            let num = 0, den1 = 0, den2 = 0;
            for (let i = 0; i < n; i++) {
                const d1 = s1[i] - mean1, d2 = s2[i] - mean2;
                num += d1 * d2; den1 += d1 * d1; den2 += d2 * d2;
            }
            return den1 && den2 ? num / Math.sqrt(den1 * den2) : 0;
        }

        function updateCorrelationMatrix() {
            const keyAssets = ['BTC', 'ETH', 'NVDA', 'AAPL'];
            const el = document.getElementById('correlation-matrix');
            if (!el) return;
            el.innerHTML = keyAssets.flatMap(id1 =>
                keyAssets.map(id2 => {
                    const a1 = assets.find(a => a.id === id1);
                    const a2 = assets.find(a => a.id === id2);
                    const corr = id1 === id2 ? 1 : (a1 && a2 ? calculateCorrelation(a1.history, a2.history) : 0);
                    const bg = corr > 0.3 ? `rgba(34,197,94,${Math.abs(corr)})` : corr < -0.3 ? `rgba(239,68,68,${Math.abs(corr)})` : 'rgba(255,255,255,0.1)';
                    return `<div style="padding:4px;text-align:center;border-radius:3px;background:${bg}" title="${id1}/${id2}">${id1 === id2 ? id1 : corr.toFixed(1)}</div>`;
                })
            ).join('');
        }

        // --- Economic Indicators ---
        const ecoData = { CPI: { v: 3.2, d: 'Inflation' }, Unemployment: { v: 3.7, d: 'Jobless' }, GDP: { v: 2.1, d: 'Growth' }, FedRate: { v: 5.25, d: 'Fed Rate' } };
        function updateEconomicIndicators() {
            const el = document.getElementById('economic-indicators');
            if (!el) return;
            el.innerHTML = Object.entries(ecoData).map(([k, d]) => {
                d.v += (Math.random() - 0.5) * 0.02;
                const color = k === 'GDP' ? 'var(--bullish)' : k === 'CPI' ? 'var(--bearish)' : 'var(--neutral)';
                return `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05)"><span>${d.d}</span><span style="font-weight:600;color:${color}">${d.v.toFixed(1)}%</span></div>`;
            }).join('');
        }

        // --- Renderers ---
        function renderTicker() {
            if (isLoading) {
                document.getElementById('ticker').innerHTML = Array(10).fill('<div class="ticker-item skeleton" style="width:100px;height:20px;margin-right:30px"></div>').join('');
                document.getElementById('ticker-2').innerHTML = '';
                return;
            }

            const html = assets.map(a => {
                const hist = a.history.slice(-10);
                const color = hist[9] > hist[0] ? 'var(--bullish)' : 'var(--bearish)';
                const points = hist.map((v, i) => `${(i / 9) * 40},${20 - ((v - Math.min(...hist)) / (Math.max(...hist) - Math.min(...hist))) * 20}`).join(' ');

                // Flash Logic
                let flashClass = '';
                if (a.history.length > 2) {
                    const latest = a.history[a.history.length - 1];
                    const prev = a.history[a.history.length - 2];
                    if (Math.abs(latest - prev) > 0.00001) { // Avoid flash on super tiny float noise
                        flashClass = latest > prev ? 'flash-up' : 'flash-down';
                    }
                }

                // Glow Logic (High volatility)
                const change24 = (a.price - a.history[0]) / a.history[0];
                let glowClass = '';
                if (change24 > 0.03) glowClass = 'bullish-glow';
                if (change24 < -0.03) glowClass = 'bearish-glow';

                return `
                <div class="ticker-item ${flashClass} ${glowClass}" onclick="openChart('${a.id}')" onmousemove="showTickerTooltip(event, '${a.id}')" onmouseleave="hideTickerTooltip()">
                    <span>${a.id}</span>
                    <svg class="sparkline" style="stroke:${color}"><polyline points="${points}"/></svg>
                    <span>${formatPrice(a.price)}</span>
                </div>`;
            }).join('');
            document.getElementById('ticker').innerHTML = html;
            document.getElementById('ticker-2').innerHTML = html;
        }

        // --- Ticker Tooltip Logic ---
        function showTickerTooltip(e, id) {
            const a = assets.find(x => x.id === id);
            if (!a) return;
            const tip = document.getElementById('ticker-tooltip');

            // Calculate Day Stats (Simulated for now based on history)
            const low = Math.min(...a.history);
            const high = Math.max(...a.history);
            const change = ((a.price - a.history[0]) / a.history[0] * 100).toFixed(2);
            const color = change >= 0 ? 'var(--bullish)' : 'var(--bearish)';

            tip.innerHTML = `
                <div style="font-weight:700; font-size:14px; margin-bottom:5px">${a.name} (${a.id})</div>
                <div style="opacity:0.8; margin-bottom:2px">Price: <b>${formatPrice(a.price)}</b></div>
                <div style="opacity:0.8; margin-bottom:2px; color:${color}">24h: ${change > 0 ? '+' : ''}${change}%</div>
                <div style="border-top:1px solid rgba(255,255,255,0.1); margin-top:5px; padding-top:5px; display:flex; justify-content:space-between; opacity:0.6; font-size:10px">
                    <span>L: ${formatPrice(low)}</span>
                    <span>H: ${formatPrice(high)}</span>
                </div>
            `;

            // Positioning (Safe bounds)
            let top = e.clientY + 15;
            let left = e.clientX + 15;
            if (left + 160 > window.innerWidth) left -= 170; // Flip left if near edge

            tip.style.top = top + 'px';
            tip.style.left = left + 'px';
            tip.style.display = 'block';
        }

        function hideTickerTooltip() {
            document.getElementById('ticker-tooltip').style.display = 'none';
        }

        // --- Economic Calendar (Timeline) ---
        function updateCalendar() {
            const events = [
                { time: '14:30', event: 'US Non-Farm Payrolls', impact: 'high', status: 'past' },
                { time: '15:00', event: 'ISM Manufacturing PMI', impact: 'medium', status: 'past' },
                { time: 'NOW', event: 'Market Open', impact: 'high', status: 'active' },
                { time: '16:00', event: 'Fed Chair Speech', impact: 'high', status: 'future' },
                { time: 'Tomorrow', event: 'ECB Rate Decision', impact: 'high', status: 'future' }
            ];

            const html = `
                <div style="margin:20px 0; border-top:1px solid var(--card-border); padding-top:20px">
                    <div style="font-weight:600; font-size:14px; margin-bottom:15px; display:flex; justify-content:space-between">
                        <span data-i18n="calendar">Market Timeline</span>
                        <span style="opacity:0.5; font-size:11px">EST</span>
                    </div>
                    <div class="timeline-container">
                    ${events.map(e => `
                        <div class="timeline-event ${e.status === 'active' ? 'active' : ''}">
                            <div style="opacity:0.6; margin-bottom:4px">${e.time}</div>
                            <div style="font-weight:600; margin-bottom:4px">${e.event}</div>
                            <div style="display:flex;align-items:center;gap:5px">
                                <span class="cal-impact" style="background:${e.impact === 'high' ? 'var(--bearish)' : 'var(--neutral)'}"></span>
                                <span style="font-size:10px;opacity:0.8">${e.impact.toUpperCase()}</span>
                            </div>
                        </div>
                    `).join('')}
                    </div>
                </div>
            `;

            const existing = document.getElementById('eco-calendar');
            if (existing) existing.innerHTML = html;
            else {
                const div = document.createElement('div');
                div.id = 'eco-calendar';
                div.innerHTML = html;
                document.getElementById('analyst-insights').after(div);
            }
        }

        // --- Stock Screener ---
        let activeFilter = 'all';
        let searchQuery = '';

        // --- Search Handler (with input validation) ---
        function handleSearch(query) {
            // Validate and sanitize search input
            const validation = InputValidator.validate(query, 'search');

            if (!validation.valid && validation.errors.length > 0) {
                // Show warning for significant validation issues
                const criticalErrors = validation.errors.filter(e => !e.includes('truncated') && !e.includes('removed'));
                if (criticalErrors.length > 0) {
                    showToast('‚ö†Ô∏è Invalid search input', 'warning');
                    return;
                }
            }

            searchQuery = (validation.value || '').toLowerCase();
            renderGrid();
        }

        // --- Bookmarks (localStorage) ---
        const savedBookmarks = JSON.parse(localStorage.getItem('newsBookmarks') || '[]');

        function toggleBookmark(articleId) {
            const idx = savedBookmarks.indexOf(articleId);
            if (idx > -1) {
                savedBookmarks.splice(idx, 1);
            } else {
                savedBookmarks.push(articleId);
            }
            localStorage.setItem('newsBookmarks', JSON.stringify(savedBookmarks));
            renderGrid();
        }

        function isBookmarked(articleId) {
            return savedBookmarks.includes(articleId);
        }

        // --- Currency Converter ---
        let currencyRates = { USD: 1, EUR: 0.92, GBP: 0.79, JPY: 149.5 };
        let activeCurrency = 'USD';

        async function fetchCurrencyRates() {
            try {
                // Use SecureFetch with rate limiting
                const res = await SecureFetch.fetch(
                    'https://api.exchangerate-api.com/v4/latest/USD',
                    'exchangerate'
                );
                if (!res.ok) {
                    if (res.status === 429) console.warn('ExchangeRate: Rate limited');
                    throw new Error('Currency API rate limited');
                }
                const data = await res.json();
                currencyRates = { USD: 1, EUR: data.rates.EUR, GBP: data.rates.GBP, JPY: data.rates.JPY };
            } catch (e) {
                console.warn('Currency API Error (using defaults):', e);
            }
        }

        function setCurrency(currency) {
            activeCurrency = currency;
            renderTicker();
            renderHeatmap();
        }

        function formatPrice(usdPrice) {
            const converted = usdPrice * (currencyRates[activeCurrency] || 1);
            const symbols = { USD: '$', EUR: '‚Ç¨', GBP: '¬£', JPY: '¬•' };
            const decimals = activeCurrency === 'JPY' ? 0 : 2;
            return symbols[activeCurrency] + converted.toFixed(decimals);
        }

        // Wire up currency selector
        document.addEventListener('DOMContentLoaded', () => {
            const currSel = document.getElementById('currency-select');
            if (currSel) {
                currSel.addEventListener('change', (e) => setCurrency(e.target.value));
            }
            fetchCurrencyRates();
        });

        // --- Sparkline Drawing ---
        function drawSparkline(canvas, data, color = '#3b82f6') {
            if (!canvas || !data || data.length < 2) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1;

            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 1.5;

            data.forEach((val, i) => {
                const x = (i / (data.length - 1)) * w;
                const y = h - ((val - min) / range) * h;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        function applyScreener(filter) {
            activeFilter = filter;

            // innovative UI feedback: scroll to top of view
            const view = document.querySelector('main');
            if (view) view.scrollIntoView({ behavior: 'smooth' });

            // Update UI Interface
            document.querySelectorAll('.filter-chip').forEach(btn => {
                if (btn.innerText.toLowerCase().includes(filter.replace('gainers', 'gain').replace('tech', 'tech').replace('crypto', 'crypto'))) {
                    btn.classList.add('active');
                } else if (filter === 'all' && btn.innerText === 'All') {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Re-render active views
            renderGrid();
            renderHeatmap();
        }

        // --- Renderers Updated for Screener & Sentiment ---
        function getSentiment(text) {
            const pos = ['surge', 'jump', 'record', 'soar', 'rally', 'approval', 'breakthrough', 'profit', 'beat', 'bull', 'trillion'];
            const neg = ['drop', 'fall', 'crash', 'miss', 'fear', 'crisis', 'selloff', 'warn', 'struggle', 'bubble', 'rout', 'threaten'];
            const txt = text.toLowerCase();
            if (pos.some(w => txt.includes(w))) return { label: 'Positive', color: 'var(--bullish)' };
            if (neg.some(w => txt.includes(w))) return { label: 'Negative', color: 'var(--bearish)' };
            return { label: 'Neutral', color: 'var(--text-secondary)' };
        }

        function renderGrid() {
            const grid = document.getElementById('grid-view');
            let allArticles = (typeof marketData !== 'undefined' ? marketData : []).flatMap(s => s.articles.map(a => ({ ...a, source: s.source })));

            // Add unique IDs if missing
            allArticles.forEach((a, i) => {
                if (!a.id) a.id = `article-${i}-${a.headline.substring(0, 20).replace(/\s/g, '')}`;
            });

            // Search Filter
            if (searchQuery) {
                allArticles = allArticles.filter(a => {
                    const txt = (a.headline + a.snippet + a.source).toLowerCase();
                    return txt.includes(searchQuery);
                });
            }

            // Category Filter Logic
            if (activeFilter !== 'all') {
                allArticles = allArticles.filter(a => {
                    const txt = (a.headline + a.snippet).toLowerCase();
                    if (activeFilter === 'tech') return txt.match(/tech|ai|chip|apple|nvidia|amd|microsoft|google/);
                    if (activeFilter === 'crypto') return txt.match(/crypto|bitcoin|coin|token|block/);
                    if (activeFilter === 'gainers') return txt.match(/surge|jump|record|soar|rally/);
                    if (activeFilter === 'saved') return isBookmarked(a.id);
                    return true;
                });
            }

            filteredArticles = allArticles;

            grid.innerHTML = filteredArticles.length ? filteredArticles.map((a, i) => {
                const sent = getSentiment(a.headline);
                const bookmarked = isBookmarked(a.id);
                return `
                <div class="article-card" style="cursor:pointer">
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px">
                         <div style="font-size:10px;opacity:0.6;text-transform:uppercase">${a.source || 'News'}</div>
                         <div style="display:flex;gap:8px;align-items:center">
                             <button onclick="event.stopPropagation();toggleBookmark('${a.id}')" style="background:none;border:none;cursor:pointer;font-size:14px;opacity:${bookmarked ? 1 : 0.4};transition:opacity 0.2s" title="${bookmarked ? 'Remove bookmark' : 'Save article'}">${bookmarked ? 'üîñ' : 'üìë'}</button>
                             <div style="font-size:9px;padding:2px 6px;border-radius:4px;background:${sent.color}20;color:${sent.color}">${sent.label}</div>
                         </div>
                    </div>
                    <div class="headline" onclick="openNews(${i})">${a.headline}</div>
                    <div style="font-size:13px;opacity:0.8" onclick="openNews(${i})">${a.snippet}</div>
                </div>`;
            }).join('') : '<div style="grid-column:1/-1;text-align:center;padding:40px;opacity:0.5">No news matches this filter.</div>';
        }

        function renderHeatmap() {
            if (isLoading) {
                document.getElementById('heatmap-view').innerHTML = Array(6).fill('<div class="heatmap-cell skeleton"></div>').join('');
                return;
            }
            const sectors = {};
            // Filter Assets
            const filteredAssets = assets.filter(a => {
                if (activeFilter === 'all') return true;
                if (activeFilter === 'tech') return a.sector === 'Tech';
                if (activeFilter === 'crypto') return a.type === 'crypto';
                if (activeFilter === 'gainers') {
                    const chg = (a.price - a.history[0]) / a.history[0];
                    return chg > 0;
                }
                return true;
            });

            filteredAssets.forEach(a => {
                if (!sectors[a.sector]) sectors[a.sector] = [];
                sectors[a.sector].push(a);
            });

            document.getElementById('heatmap-view').innerHTML = Object.keys(sectors).length ? Object.keys(sectors).map(s => {
                const items = sectors[s];
                const change = items.reduce((acc, i) => acc + (i.price - i.history[0]) / i.history[0], 0) / items.length;
                const hue = change >= 0 ? 142 : 0;

                let glowClass = '';
                if (change > 0.02) glowClass = 'bullish-glow';
                if (change < -0.02) glowClass = 'bearish-glow';

                return `<div class="heatmap-cell ${glowClass}" onclick="showSectorDetails('${s}')" style="background:hsl(${hue}, ${Math.min(Math.abs(change) * 5000, 80)}%, 30%)">
                    <div style="font-size:18px;font-weight:bold">${s}</div>
                    <div>${(change * 100).toFixed(2)}%</div>
                    <div style="font-size:11px;opacity:0.7;margin-top:5px">${items.length} Assets</div>
                </div>`;
            }).join('') : '<div style="grid-column:1/-1;text-align:center;padding:40px;opacity:0.5">No assets match this filter.</div>';
        }
        function renderCloud() {
            const words = ['Market', 'Rate', 'Growth', 'AI', 'Crypto', 'Stocks', 'Fed', 'Inflation', 'Tech', 'Oil', 'China', 'Earnings'];
            document.getElementById('word-cloud').innerHTML = words.map(w =>
                `<span class="cloud-tag" style="font-size:${12 + Math.random() * 20}px;opacity:${0.5 + Math.random() * 0.5}">${w}</span>`
            ).join('');
        }

        // --- TradingView Chart V3 ---
        function getTVSymbol(name, id, type) {
            // Heuristics for TradingView Symbols
            if (type === 'crypto') return `BINANCE:${id}USDT`;
            if (type === 'forex') return `FX:${id}`;
            if (type === 'commodity') {
                if (id === 'GOLD') return 'OANDA:XAUUSD';
                if (id === 'SILVER') return 'OANDA:XAGUSD';
                if (id === 'OIL') return 'TVC:USOIL';
                return `TVC:${id}`; // Fallback
            }
            // Stocks - Try NASDAQ/NYSE
            const nyse = ['JPM', 'V', 'MA', 'BAC', 'GS', 'MS', 'C', 'WFC', 'WMT', 'KO', 'MCD', 'NKE', 'HD', 'LOW', 'DIS', 'XOM', 'CVX', 'BA', 'GE', 'CAT', 'LMT', 'RTX', 'DE'];
            return nyse.includes(id) ? `NYSE:${id}` : `NASDAQ:${id}`;
        }

        function openChart(id) {
            currentAssetId = id;
            const asset = assets.find(a => a.id === id);
            document.getElementById('chart-modal').style.display = 'flex';
            document.getElementById('chart-title').innerText = `${asset.name} (${asset.id})`;

            // Initialize TradingView Widget
            if (document.getElementById('tv-chart')) {
                document.getElementById('tv-chart').innerHTML = ''; // Clear previous
                new TradingView.widget({
                    "autosize": true,
                    "symbol": getTVSymbol(asset.name, asset.id, asset.type),
                    "interval": "D",
                    "timezone": "Etc/UTC",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "allow_symbol_change": true,
                    "container_id": "tv-chart",
                    "hide_side_toolbar": false
                });
            }
        }

        function closeChart() { document.getElementById('chart-modal').style.display = 'none'; currentAssetId = null; }

        let currentNewsArticle = null;

        function openNews(index) {
            const article = filteredArticles[index];
            if (!article) return;
            currentNewsArticle = article; // Store for sharing
            document.getElementById('news-source').innerText = article.source || 'News';
            document.getElementById('news-headline').innerText = article.headline;
            document.getElementById('news-snippet').innerText = article.snippet;
            document.getElementById('news-link-btn').onclick = () => window.open(article.link, '_blank');
            document.getElementById('news-modal').style.display = 'flex';
        }

        function closeNews() {
            document.getElementById('news-modal').style.display = 'none';
            currentNewsArticle = null;
        }

        // --- Social Sharing ---
        function shareToTwitter() {
            if (!currentNewsArticle) return;
            const text = encodeURIComponent(`${currentNewsArticle.headline} via @MarketPulse`);
            const url = encodeURIComponent(currentNewsArticle.link || window.location.href);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=550,height=420');
        }

        function shareToLinkedIn() {
            if (!currentNewsArticle) return;
            const url = encodeURIComponent(currentNewsArticle.link || window.location.href);
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank', 'width=550,height=520');
        }

        function copyNewsLink() {
            if (!currentNewsArticle) return;
            const link = currentNewsArticle.link || window.location.href;
            navigator.clipboard.writeText(link).then(() => {
                showToast('Link copied to clipboard!', 'info');
            }).catch(() => {
                showToast('Failed to copy link', 'down');
            });
        }

        // --- Sector Drill-down ---
        function showSectorDetails(sector) {
            const items = assets.filter(a => a.sector === sector);
            document.getElementById('sector-title').innerText = sector;
            document.getElementById('sector-subtitle').innerText = `${items.length} Assets in this sector`;

            document.getElementById('sector-list').innerHTML = items.map(a => {
                const change = (a.price - a.history[0]) / a.history[0];
                const color = change >= 0 ? 'var(--bullish)' : 'var(--bearish)';
                const hist = a.history.slice(-10);
                const points = hist.map((v, i) => `${(i / 9) * 50},${15 - ((v - Math.min(...hist)) / (Math.max(...hist) - Math.min(...hist))) * 15}`).join(' ');

                return `
                <tr style="border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer" onclick="openChart('${a.id}');closeSector()">
                    <td style="padding:15px 10px; font-weight:500">
                        <div style="display:flex;align-items:center;gap:10px">
                            <div style="width:24px;height:24px;background:rgba(255,255,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px">${a.id[0]}</div>
                            ${a.name} <span style="opacity:0.5;font-size:10px">${a.id}</span>
                        </div>
                    </td>
                    <td style="padding:10px">${formatPrice(a.price)}</td>
                    <td style="padding:10px">
                         <svg width="50" height="15" style="stroke:${color}; fill:none; stroke-width:1.5"><polyline points="${points}"/></svg>
                    </td>
                    <td style="padding:10px; text-align:right; color:${color}">${(change * 100).toFixed(2)}%</td>
                </tr>`;
            }).join('');

            document.getElementById('sector-modal').style.display = 'flex';
        }

        function closeSector() {
            document.getElementById('sector-modal').style.display = 'none';
        }

        // --- Comparision Logic ---
        function compareAsset(compareId) {
            if (!compareId || !chart) return;
            const compareSeries = chart.addLineSeries({ color: '#fbbf24', lineWidth: 2, title: compareId });

            // Basic Compare: Normalize to start at same point or just overlay
            // Ideally we fetch history for `compareId`, here we simulate or use existing asset history
            const target = assets.find(a => a.id === compareId);
            if (!target) return;

            let time = Math.floor(Date.now() / 1000) - (target.history.length * 86400);
            const data = target.history.map(p => {
                time += 86400;
                return { time, value: p };
            });

            compareSeries.setData(data);
            chart.timeScale().fitContent();
        }

        // --- AI Analyst ---
        function analyzeSentiment() {
            const headlines = (typeof marketData !== 'undefined' ? marketData : []).flatMap(s => s.articles.map(a => a.headline)).join(' ');
            const pos = (headlines.match(/surge|record|jump|growth|high|bull/gi) || []).length;
            const neg = (headlines.match(/drop|crash|fear|inflation|crisis|bear/gi) || []).length;
            const score = 50 + (pos - neg) * 5;
            const val = Math.max(0, Math.min(100, score));

            const el = document.getElementById('sentiment-val');
            el.innerText = val;
            el.style.color = val > 60 ? 'var(--bullish)' : (val < 40 ? 'var(--bearish)' : 'var(--neutral)');
            document.getElementById('sentiment-text').innerText = val > 60 ? "Greed" : (val < 40 ? "Fear" : "Neutral");

            document.getElementById('analyst-insights').innerHTML = `
                <div class="analysis-point">Market sentiment is leaning <b>${val > 50 ? 'Bullish' : 'Bearish'}</b> driven by ${pos > neg ? 'growth narratives' : 'risk factors'}.</div>
            `;
        }
        function toggleSidebar() { document.body.classList.toggle('sidebar-open'); }

        // --- Simulation / Live Data Loop ---
        async function simulateMarket() {
            await DataService.updateAssets();
            updateCurrency(currentCurrency);
            updateFearGreed();
            updateAuroraIntensity();
        }

        // --- Helpers ---
        function formatPrice(p) { return syms[currentCurrency] + (p * rates[currentCurrency]).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function updateCurrency(c) { currentCurrency = c; renderTicker(); }
        function toggleTheme() { document.documentElement.dataset.theme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark'; }
        function showToast(msg, type = 'info') {
            const t = document.createElement('div'); t.className = 'toast';
            const icon = type === 'up' ? 'üìà' : (type === 'down' ? 'üìâ' : 'üîî');
            t.innerHTML = `${icon} ${msg}`;
            const c = document.getElementById('toast-container'); c.appendChild(t);
            setTimeout(() => t.style.transform = 'translateX(0)', 10);
            setTimeout(() => { t.style.transform = 'translateX(100%)'; setTimeout(() => t.remove(), 300); }, 5000);
        }
        function setView(v) {
            document.getElementById('grid-view').classList.toggle('view-hidden', v !== 'grid');
            document.getElementById('heatmap-view').classList.toggle('view-hidden', v === 'grid');
        }


        // --- Export CSV ---
        function exportCSV() {
            const headers = ["ID,Name,Type,Sector,Price,Change%"];
            const rows = assets.map(a => {
                const change = ((a.price - a.history[0]) / a.history[0] * 100).toFixed(2);
                return `${a.id},${a.name},${a.type},${a.sector},${a.price.toFixed(2)},${change}%`;
            });

            const csvContent = "data:text/csv;charset=utf-8," + headers.concat(rows).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `market_pulse_data_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Market Data Exported", "info");
        }



        // --- PWA ---
        function initPWA() {
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('service-worker.js');
        }

        init();
    </script>
</body>

</html>